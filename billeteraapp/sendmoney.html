<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Enviar Dinero</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style> body { background-color: #f8f9fa; padding-top: 20px; } .contact-item { cursor: pointer; transition: 0.2s; } .contact-item:hover, .contact-item.active { background-color: #e9ecef; border-left: 5px solid #0d6efd; } </style>
</head>
<body>

<div class="container" style="max-width: 600px;">
  <div class="card shadow border-0 rounded-4 p-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h2 class="fw-bold">Enviar Dinero</h2>
      <a href="menu.html" class="btn-close"></a>
    </div>

    <!-- Buscador -->
    <div class="input-group mb-3">
      <input type="text" class="form-control" id="searchContact" placeholder="Buscar por nombre o alias...">
      <button class="btn btn-outline-secondary" type="button" id="btnSearch">Buscar</button>
    </div>

    <!-- Botón toggle agregar contacto -->
    <button id="btnShowAddContact" class="btn btn-outline-primary w-100 mb-3 dashed-border">
      + Agregar nuevo contacto
    </button>

    <!-- Formulario Agregar Contacto (Oculto por defecto) -->
    <div id="addContactContainer" class="card bg-light p-3 mb-3" style="display: none;">
      <h5 class="mb-3">Nuevo Contacto</h5>
      <form id="formAddContact">
        <div class="row g-2">
          <div class="col-6"><input type="text" class="form-control" id="newCbu" placeholder="CBU (22 núm)" required></div>
          <div class="col-6"><input type="text" class="form-control" id="newAlias" placeholder="Alias" required></div>
          <div class="col-6"><input type="text" class="form-control" id="newBank" placeholder="Banco" required></div>
          <div class="col-6"><input type="text" class="form-control" id="newName" placeholder="Nombre completo" required></div>
        </div>
        <div class="mt-3 d-flex gap-2">
          <button type="submit" class="btn btn-primary btn-sm">Guardar</button>
          <button type="button" id="btnCancelAdd" class="btn btn-secondary btn-sm">Cancelar</button>
        </div>
      </form>
    </div>

    <!-- Lista de Contactos -->
    <label class="text-muted small mb-2">Selecciona un contacto:</label>
    <div class="list-group mb-4" id="contactsList">
      <!-- Se llena con jQuery -->
    </div>

    <!-- Zona de Envío (Oculta hasta seleccionar contacto) -->
    <div id="sendZone" style="display: none;" class="border-top pt-3">
      <h5 id="selectedContactName" class="text-primary fw-bold"></h5>
      <div class="mb-3">
        <label>Monto a transferir:</label>
        <input type="number" id="transferAmount" class="form-control" placeholder="$ 0.00">
      </div>
      <button id="btnConfirmSend" class="btn btn-primary w-100 py-2 rounded-pill">Enviar Dinero</button>
    </div>

    <div id="successMsg" class="alert alert-success mt-3" style="display:none;"></div>
  </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
  $(document).ready(function() {
    let contacts = JSON.parse(localStorage.getItem('walletContacts')) || [];

    // Función renderizar contactos
    function renderContacts(filterText = '') {
      $('#contactsList').empty();
      const filtered = contacts.filter(c =>
        c.name.toLowerCase().includes(filterText.toLowerCase()) ||
        c.alias.toLowerCase().includes(filterText.toLowerCase())
      );

      if(filtered.length === 0) {
        $('#contactsList').html('<div class="text-muted p-2">No se encontraron contactos.</div>');
        return;
      }

      filtered.forEach((c, index) => {
        $('#contactsList').append(`
                        <a href="#" class="list-group-item list-group-item-action contact-item" data-name="${c.name}">
                            <div class="d-flex w-100 justify-content-between">
                                <h6 class="mb-1">${c.name}</h6>
                                <small>${c.bank}</small>
                            </div>
                            <small class="text-muted">Alias: ${c.alias}</small>
                        </a>
                    `);
      });
    }

    renderContacts();

    // Toggle Formulario Agregar
    $('#btnShowAddContact').click(() => $('#addContactContainer').slideDown());
    $('#btnCancelAdd').click(() => $('#addContactContainer').slideUp());

    // Validar y Agregar Contacto
    $('#formAddContact').submit(function(e) {
      e.preventDefault();
      // Validaciones básicas
      const cbu = $('#newCbu').val();
      if(cbu.length < 5) { alert("CBU inválido"); return; } // Validación simple ejemplo

      const newContact = {
        name: $('#newName').val(),
        cbu: cbu,
        alias: $('#newAlias').val(),
        bank: $('#newBank').val()
      };

      contacts.push(newContact);
      localStorage.setItem('walletContacts', JSON.stringify(contacts));
      renderContacts();
      $('#addContactContainer').slideUp();
      $('#formAddContact')[0].reset();
    });

    // Buscar en agenda
    $('#btnSearch').click(() => renderContacts($('#searchContact').val()));
    $('#searchContact').on('keyup', function() { renderContacts($(this).val()); });

    // Seleccionar Contacto (Delegación de eventos)
    $(document).on('click', '.contact-item', function(e) {
      e.preventDefault();
      $('.contact-item').removeClass('active');
      $(this).addClass('active');

      const name = $(this).data('name');
      $('#selectedContactName').text(`Enviando a: ${name}`);
      $('#sendZone').fadeIn();
    });

    // Enviar Dinero
    $('#btnConfirmSend').click(function() {
      const amount = parseFloat($('#transferAmount').val());
      const currentBal = parseFloat(localStorage.getItem('walletBalance')) || 0;

      if(!amount || amount <= 0) { alert("Ingresa un monto válido"); return; }
      if(amount > currentBal) { alert("Saldo insuficiente"); return; }

      // Descontar
      localStorage.setItem('walletBalance', currentBal - amount);

      // Guardar Movimiento
      let trans = JSON.parse(localStorage.getItem('walletTransactions')) || [];
      trans.unshift({
        tipo: 'transferencia',
        descripcion: 'Envío a ' + $('#selectedContactName').text().replace('Enviando a: ', ''),
        monto: amount,
        fecha: new Date().toLocaleDateString()
      });
      localStorage.setItem('walletTransactions', JSON.stringify(trans));

      // Confirmación visual
      $('#sendZone').hide();
      $('#contactsList').hide();
      $('#successMsg').text(`¡Transferencia de $${amount} realizada con éxito!`).fadeIn();

      setTimeout(() => window.location.href = 'menu.html', 2500);
    });
  });
</script>
</body>
</html>
